<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cambridge English A2 KET Mock Test 1</title>
  <style>
    :root {
  /* Primitive Color Tokens */
  --color-white: rgba(255, 255, 255, 1);
  --color-black: rgba(0, 0, 0, 1);
  --color-cream-50: rgba(252, 252, 249, 1);
  --color-cream-100: rgba(255, 255, 253, 1);
  --color-gray-200: rgba(245, 245, 245, 1);
  --color-gray-300: rgba(167, 169, 169, 1);
  --color-gray-400: rgba(119, 124, 124, 1);
  --color-slate-500: rgba(98, 108, 113, 1);
  --color-brown-600: rgba(94, 82, 64, 1);
  --color-charcoal-700: rgba(31, 33, 33, 1);
  --color-charcoal-800: rgba(38, 40, 40, 1);
  --color-slate-900: rgba(19, 52, 59, 1);
  --color-teal-300: rgba(50, 184, 198, 1);
  --color-teal-400: rgba(45, 166, 178, 1);
  --color-teal-500: rgba(33, 128, 141, 1);
  --color-teal-600: rgba(29, 116, 128, 1);
  --color-teal-700: rgba(26, 104, 115, 1);
  --color-teal-800: rgba(41, 150, 161, 1);
  --color-red-400: rgba(255, 84, 89, 1);
  --color-red-500: rgba(192, 21, 47, 1);
  --color-orange-400: rgba(230, 129, 97, 1);
  --color-orange-500: rgba(168, 75, 47, 1);

  --color-brown-600-rgb: 94, 82, 64;
  --color-teal-500-rgb: 33, 128, 141;
  --color-slate-900-rgb: 19, 52, 59;
  --color-slate-500-rgb: 98, 108, 113;

  --color-bg-1: rgba(59, 130, 246, 0.08);
  --color-bg-2: rgba(245, 158, 11, 0.08);
  --color-bg-3: rgba(34, 197, 94, 0.08);
  --color-bg-4: rgba(239, 68, 68, 0.08);

  --color-background: var(--color-cream-50);
  --color-surface: var(--color-cream-100);
  --color-text: var(--color-slate-900);
  --color-text-secondary: var(--color-slate-500);
  --color-primary: var(--color-teal-500);
  --color-primary-hover: var(--color-teal-600);
  --color-primary-active: var(--color-teal-700);
  --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
  --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
  --color-border: rgba(var(--color-brown-600-rgb), 0.2);
  --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);

  --font-family-base: "FKGroteskNeue", "Geist", "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  --font-size-xs: 11px;
  --font-size-sm: 12px;
  --font-size-base: 14px;
  --font-size-md: 14px;
  --font-size-lg: 16px;
  --font-size-xl: 18px;
  --font-size-2xl: 20px;
  --font-size-3xl: 24px;
  --font-weight-normal: 400;
  --font-weight-medium: 500;
  --font-weight-semibold: 550;
  --font-weight-bold: 600;
  --line-height-normal: 1.5;
  --line-height-tight: 1.2;

  --space-4: 4px;
  --space-8: 8px;
  --space-12: 12px;
  --space-16: 16px;
  --space-20: 20px;
  --space-24: 24px;
  --space-32: 32px;

  --radius-sm: 6px;
  --radius-base: 8px;
  --radius-md: 10px;
  --radius-lg: 12px;

  --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04), 0 2px 4px -1px rgba(0, 0, 0, 0.02);

  --duration-fast: 150ms;
  --duration-normal: 250ms;
  --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);
}

@font-face {
  font-family: 'FKGroteskNeue';
  src: url('https://r2cdn.perplexity.ai/fonts/FKGroteskNeue.woff2') format('woff2');
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: var(--font-family-base);
  font-size: var(--font-size-base);
  line-height: var(--line-height-normal);
  color: var(--color-text);
  background-color: var(--color-background);
  -webkit-font-smoothing: antialiased;
  transition: background-color var(--duration-normal) var(--ease-standard), color var(--duration-normal) var(--ease-standard);
}

.app-container {
  display: flex;
  flex-direction: column;
  min-height: 100vh;
}

/* Settings Panel */
.settings-panel {
  background-color: var(--color-surface);
  border-bottom: 1px solid var(--color-border);
  padding: var(--space-16);
  position: sticky;
  top: 0;
  z-index: 100;
  transition: background-color var(--duration-normal) var(--ease-standard);
}

.settings-grid {
  display: flex;
  flex-wrap: wrap;
  gap: var(--space-24);
  align-items: center;
  max-width: 1200px;
  margin: 0 auto;
}

.setting-group {
  display: flex;
  align-items: center;
  gap: var(--space-12);
  flex: 1;
  min-width: 200px;
}

.setting-label {
  font-weight: var(--font-weight-medium);
  font-size: var(--font-size-sm);
  color: var(--color-text-secondary);
  white-space: nowrap;
}

.toggle-btn {
  padding: var(--space-8) var(--space-16);
  background-color: var(--color-primary);
  color: var(--color-white);
  border: none;
  border-radius: var(--radius-base);
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-medium);
  cursor: pointer;
  transition: background-color var(--duration-fast) var(--ease-standard);
  min-width: 100px;
}

.toggle-btn:hover {
  background-color: var(--color-primary-hover);
}

.toggle-btn.inactive {
  background-color: var(--color-secondary);
  color: var(--color-text);
}

.font-size-control {
  display: flex;
  align-items: center;
  gap: var(--space-8);
}

.font-slider {
  width: 120px;
  height: 6px;
  -webkit-appearance: none;
  appearance: none;
  background: var(--color-secondary);
  border-radius: var(--radius-sm);
  outline: none;
}

.font-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 18px;
  height: 18px;
  background: var(--color-primary);
  border-radius: 50%;
  cursor: pointer;
}

.font-slider::-moz-range-thumb {
  width: 18px;
  height: 18px;
  background: var(--color-primary);
  border-radius: 50%;
  cursor: pointer;
  border: none;
}

.font-value {
  font-size: var(--font-size-sm);
  color: var(--color-text-secondary);
  min-width: 35px;
}

.color-scheme-buttons {
  display: flex;
  gap: var(--space-8);
}

.color-btn {
  padding: var(--space-8) var(--space-16);
  background-color: var(--color-secondary);
  color: var(--color-text);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-base);
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-medium);
  cursor: pointer;
  transition: all var(--duration-fast) var(--ease-standard);
  white-space: nowrap;
}

.color-btn:hover {
  background-color: var(--color-secondary-hover);
}

.color-btn.active {
  background-color: var(--color-primary);
  color: var(--color-white);
  border-color: var(--color-primary);
}

/* Main Layout */
.main-layout {
  display: flex;
  flex: 1;
  max-width: 1400px;
  margin: 0 auto;
  width: 100%;
}

.sidebar {
  width: 250px;
  background-color: var(--color-surface);
  border-right: 1px solid var(--color-border);
  padding: var(--space-24);
  overflow-y: auto;
  transition: transform var(--duration-normal) var(--ease-standard), background-color var(--duration-normal) var(--ease-standard);
}

.sidebar.mobile-hidden {
  transform: translateX(-100%);
  position: fixed;
  height: calc(100vh - 80px);
  z-index: 50;
}

.sidebar.mobile-visible {
  transform: translateX(0);
  position: fixed;
  height: calc(100vh - 80px);
  z-index: 50;
}

.mobile-menu-btn {
  display: none;
  position: fixed;
  bottom: var(--space-24);
  right: var(--space-24);
  width: 56px;
  height: 56px;
  background-color: var(--color-primary);
  color: var(--color-white);
  border: none;
  border-radius: 50%;
  font-size: var(--font-size-2xl);
  cursor: pointer;
  box-shadow: var(--shadow-md);
  z-index: 60;
}

.part-nav {
  list-style: none;
}

.part-nav-item {
  margin-bottom: var(--space-8);
}

.part-nav-link {
  display: block;
  padding: var(--space-12) var(--space-16);
  background-color: transparent;
  color: var(--color-text);
  border: 1px solid transparent;
  border-radius: var(--radius-base);
  font-size: var(--font-size-base);
  cursor: pointer;
  transition: all var(--duration-fast) var(--ease-standard);
  text-align: left;
  width: 100%;
}

.part-nav-link:hover {
  background-color: var(--color-secondary);
}

.part-nav-link.active {
  background-color: var(--color-primary);
  color: var(--color-white);
}

.content-area {
  flex: 1;
  padding: var(--space-32);
  overflow-y: auto;
}

/* Landing Screen */
.landing-screen {
  max-width: 600px;
  margin: 0 auto;
  text-align: center;
}

.landing-screen h1 {
  font-size: var(--font-size-3xl);
  margin-bottom: var(--space-16);
  color: var(--color-text);
}

.landing-screen p {
  font-size: var(--font-size-lg);
  color: var(--color-text-secondary);
  margin-bottom: var(--space-32);
}

.image-upload-section {
  background-color: var(--color-surface);
  border: 2px dashed var(--color-border);
  border-radius: var(--radius-lg);
  padding: var(--space-32);
  margin-bottom: var(--space-32);
}

.image-upload-section h2 {
  font-size: var(--font-size-xl);
  margin-bottom: var(--space-16);
  color: var(--color-text);
}

.image-preview-container {
  display: flex;
  gap: var(--space-16);
  justify-content: center;
  flex-wrap: wrap;
  margin-top: var(--space-24);
}

.image-preview-box {
  position: relative;
  width: 150px;
  text-align: center;
}

.image-preview-box img {
  width: 150px;
  height: 150px;
  object-fit: cover;
  border-radius: var(--radius-base);
  border: 2px solid var(--color-border);
}

.reorder-buttons {
  display: flex;
  justify-content: center;
  gap: var(--space-8);
  margin-top: var(--space-8);
}

.reorder-btn {
  padding: var(--space-4) var(--space-12);
  background-color: var(--color-secondary);
  color: var(--color-text);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-sm);
  font-size: var(--font-size-sm);
  cursor: pointer;
  transition: background-color var(--duration-fast) var(--ease-standard);
}

.reorder-btn:hover {
  background-color: var(--color-secondary-hover);
}

.reorder-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.timer-display {
  font-size: var(--font-size-2xl);
  font-weight: var(--font-weight-bold);
  color: var(--color-primary);
  padding: var(--space-8) var(--space-16);
  background-color: var(--color-bg-1);
  border-radius: var(--radius-base);
  border: 2px solid var(--color-border);
}

.timer-display.warning {
  color: var(--color-red-500);
  animation: pulse 1s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

.submit-btn {
  padding: var(--space-12) var(--space-24);
  background-color: var(--color-primary);
  color: var(--color-white);
  border: none;
  border-radius: var(--radius-base);
  font-size: var(--font-size-base);
  font-weight: var(--font-weight-semibold);
  cursor: pointer;
  transition: background-color var(--duration-fast) var(--ease-standard);
}

.submit-btn:hover {
  background-color: var(--color-primary-hover);
}

.submit-btn.highlight {
  animation: pulse 1s infinite;
  background-color: var(--color-red-500);
}

.upload-instruction {
  color: var(--color-text-secondary);
  margin-bottom: var(--space-16);
}

.image-upload-input {
  display: block;
  margin: 0 auto var(--space-16);
  padding: var(--space-8);
  font-size: var(--font-size-sm);
}

.uploaded-images {
  display: flex;
  gap: var(--space-16);
  justify-content: center;
  flex-wrap: wrap;
  margin-top: var(--space-16);
}

.uploaded-image {
  width: 120px;
  height: 120px;
  object-fit: cover;
  border-radius: var(--radius-base);
  border: 2px solid var(--color-border);
}

.start-test-btn {
  padding: var(--space-16) var(--space-32);
  background-color: var(--color-primary);
  color: var(--color-white);
  border: none;
  border-radius: var(--radius-base);
  font-size: var(--font-size-lg);
  font-weight: var(--font-weight-semibold);
  cursor: pointer;
  transition: background-color var(--duration-fast) var(--ease-standard);
}

.start-test-btn:hover {
  background-color: var(--color-primary-hover);
}

.start-test-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Part Content */
.part-content {
  max-width: 1200px;
}

/* Parts 1-3: Side-by-side layout for text and questions */
.part-content-wrapper {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: var(--space-24);
  margin-bottom: var(--space-24);
}

/* When text is hidden, make the questions take full width */
.part-content-wrapper.text-hidden {
  grid-template-columns: 1fr;
}

/* Part 4 passage: keep visible while scrolling questions */
.part4-text {
  position: sticky;
  top: 80px; /* default, overridden by JS to match settings panel height */
  align-self: start;
  max-height: calc(100vh - 120px);
  overflow-y: auto;
  padding-right: var(--space-8);
}
/* On small screens we keep sticky but JS will compute the correct `top` so it doesn't sit under the top bar. */

.text-area {
  padding: var(--space-16);
  border-right: 1px solid var(--color-border);
  max-height: 70vh;
  overflow-y: auto;
}

.text-area.hidden {
  display: none;
}

.questions-area {
  overflow-y: auto;
  max-height: 70vh;
}

@media (max-width: 768px) {
  .part-content-wrapper {
    grid-template-columns: 1fr;
  }
  
  .text-area {
    border-right: none;
    border-bottom: 1px solid var(--color-border);
    max-height: 50vh;
  }
}

.part-title {
  font-size: var(--font-size-2xl);
  margin-bottom: var(--space-24);
  color: var(--color-text);
}

.passage {
  background-color: var(--color-surface);
  padding: var(--space-24);
  border-radius: var(--radius-lg);
  border: 1px solid var(--color-card-border);
  margin-bottom: var(--space-24);
  line-height: 1.8;
  transition: background-color var(--duration-normal) var(--ease-standard);
}

.passage p {
  margin: 0 0 0.5em 0;
}

.passage p:last-child {
  margin-bottom: 0;
}

.passage.hidden {
  display: none;
}

.passage-title {
  font-size: var(--font-size-xl);
  font-weight: var(--font-weight-semibold);
  margin-bottom: var(--space-16);
  color: var(--color-text);
}

.question-block {
  background-color: var(--color-surface);
  padding: var(--space-20);
  border-radius: var(--radius-lg);
  border: 1px solid var(--color-card-border);
  margin-bottom: var(--space-20);
  transition: background-color var(--duration-normal) var(--ease-standard);
}

.question-text {
  font-weight: var(--font-weight-medium);
  margin-bottom: var(--space-16);
  color: var(--color-text);
  line-height: 1.6;
}

.options {
  display: flex;
  flex-direction: column;
  gap: var(--space-12);
}

.option-label {
  display: flex;
  align-items: flex-start;
  padding: var(--space-12) var(--space-16);
  background-color: var(--color-background);
  border: 2px solid var(--color-border);
  border-radius: var(--radius-base);
  cursor: pointer;
  transition: all var(--duration-fast) var(--ease-standard);
  min-height: 44px;
}

.option-label:hover {
  border-color: var(--color-primary);
  background-color: var(--color-bg-1);
}

.option-label.selected {
  border-color: var(--color-primary);
  background-color: var(--color-bg-1);
}

.option-radio {
  margin-right: var(--space-12);
  margin-top: 2px;
  width: 18px;
  height: 18px;
  flex-shrink: 0;
  cursor: pointer;
}

.option-text {
  flex: 1;
  line-height: 1.5;
}

/* Part 4 Layout */
.part4-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: var(--space-24);
}

/* Part 5 - Fill Gaps */
.gap-text {
  background-color: var(--color-surface);
  padding: var(--space-24);
  border-radius: var(--radius-lg);
  border: 1px solid var(--color-card-border);
  line-height: 2;
  font-size: var(--font-size-base);
}

.gap-input-wrapper {
  display: inline-block;
  position: relative;
  margin: 0 var(--space-4);
}

.gap-number {
  display: inline-block;
  font-weight: var(--font-weight-bold);
  color: var(--color-primary);
  cursor: pointer;
  padding: var(--space-4) var(--space-8);
  background-color: var(--color-bg-1);
  border-radius: var(--radius-sm);
  min-width: 80px;
  text-align: center;
  border: 2px solid transparent;
  transition: border-color var(--duration-fast) var(--ease-standard);
}

.gap-number:hover {
  border-color: var(--color-primary);
}

.gap-input {
  display: inline-block;
  padding: var(--space-4) var(--space-8);
  border: 2px solid var(--color-primary);
  border-radius: var(--radius-sm);
  font-size: var(--font-size-base);
  font-family: var(--font-family-base);
  min-width: 100px;
  background-color: var(--color-surface);
  color: var(--color-text);
}

body.dark-mode .gap-input,
body.dark-mode .writing-textarea {
  background-color: rgba(60, 60, 60, 1);
  color: var(--color-gray-200);
  border-color: rgba(119, 124, 124, 0.5);
}

body.warm-mode .gap-input,
body.warm-mode .writing-textarea {
  background-color: rgba(60, 60, 60, 1);
  color: #FFFF00;
  border-color: rgba(255, 255, 0, 0.3);
}

.gap-input.error {
  border-color: var(--color-red-500);
}

.error-message {
  display: block;
  color: var(--color-red-500);
  font-size: var(--font-size-xs);
  margin-top: var(--space-4);
  font-weight: var(--font-weight-medium);
}

/* Writing Parts */
.writing-section {
  background-color: var(--color-surface);
  padding: var(--space-24);
  border-radius: var(--radius-lg);
  border: 1px solid var(--color-card-border);
}

.writing-prompt {
  margin-bottom: var(--space-24);
  line-height: 1.8;
  color: var(--color-text);
}

.writing-textarea {
  width: 100%;
  min-height: 200px;
  padding: var(--space-16);
  border: 2px solid var(--color-border);
  border-radius: var(--radius-base);
  font-family: var(--font-family-base);
  font-size: var(--font-size-base);
  line-height: 1.6;
  resize: vertical;
  background-color: var(--color-background);
  color: var(--color-text);
  transition: border-color var(--duration-fast) var(--ease-standard);
}

.writing-textarea:focus {
  outline: none;
  border-color: var(--color-primary);
}

.word-count {
  margin-top: var(--space-12);
  font-size: var(--font-size-sm);
  color: var(--color-text-secondary);
  font-weight: var(--font-weight-medium);
}

/* Part 7 Images */
.image-carousel {
  display: flex;
  gap: var(--space-16);
  margin-bottom: var(--space-24);
  overflow-x: auto;
  padding: var(--space-8);
}

.story-image {
  width: 200px;
  height: 200px;
  object-fit: contain; /* show full image without cropping */
  object-position: center;
  border-radius: 0; /* square images */
  border: 2px solid var(--color-border);
  background-color: var(--color-background);
  flex-shrink: 0;
}

/* Color Scheme Variations */
body.dark-mode {
  --color-background: var(--color-charcoal-700);
  --color-surface: var(--color-charcoal-800);
  --color-text: var(--color-gray-200);
  --color-text-secondary: rgba(167, 169, 169, 0.7);
  --color-border: rgba(119, 124, 124, 0.3);
  --color-card-border: rgba(119, 124, 124, 0.2);
}

body.warm-mode {
  --color-background: var(--color-charcoal-700);
  --color-surface: var(--color-charcoal-800);
  --color-text: #FFFF00;
  --color-text-secondary: rgba(255, 255, 0, 0.7);
  --color-border: rgba(255, 255, 0, 0.3);
  --color-card-border: rgba(255, 255, 0, 0.2);
}

/* Responsive Design */
@media (max-width: 768px) {
  .settings-grid {
    flex-direction: column;
    align-items: stretch;
  }

  .setting-group {
    width: 100%;
  }

  .color-scheme-buttons {
    flex-wrap: wrap;
  }

  .sidebar {
    position: fixed;
    left: 0;
    top: 80px;
    height: calc(100vh - 80px);
    transform: translateX(-100%);
    z-index: 50;
  }

  .sidebar.mobile-visible {
    transform: translateX(0);
  }

  .mobile-menu-btn {
    display: block;
  }

  .content-area {
    padding: var(--space-16);
  }

  .part4-grid {
    grid-template-columns: 1fr;
  }

  .image-carousel {
    flex-direction: column;
  }

  .story-image {
    width: 100%;
    max-width: 300px;
  }
}

@media (max-width: 480px) {
  .settings-panel {
    padding: 4px 6px; /* further reduce vertical padding for smaller top bar */
    --small-settings-padding: 6px;
  }

  .part-title {
    font-size: var(--font-size-xl);
  }

  .color-btn {
    padding: var(--space-8) var(--space-12);
    font-size: var(--font-size-xs);
  }

  /* Compact settings layout for very small screens */
  .settings-grid {
    gap: 8px;
    align-items: center;
  }

  .setting-group {
    min-width: 0;
    gap: 6px;
  }

  .setting-label { display: none; }

  .toggle-btn, .submit-btn, .color-btn, .start-test-btn {
    padding: 6px 10px;
    font-size: 13px;
    min-width: 64px;
  }

  .timer-display {
    padding: 4px 8px;
    font-size: 14px;
  }

  /* Keep settings panel to at most two rows by using a 3-column grid (3+2 items => 2 rows) */
  .settings-grid {
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    grid-template-rows: auto auto;
    grid-template-areas:
      "time submit text"
      "font color color";
    gap: 6px;
    overflow-x: hidden;
  }

  /* Show font and color controls in the second row */
  .font-size-control {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .color-scheme-buttons {
    display: flex;
    gap: 6px;
  }

  .setting-label { display: none; }

  .setting-group {
    min-width: 0;
    gap: 6px;
    padding: 2px 4px;
  }

  .toggle-btn, .submit-btn, .color-btn, .start-test-btn {
    padding: 4px 8px;
    font-size: 12px;
    min-width: 56px;
  }

  .timer-display {
    padding: 2px 6px;
    font-size: 13px;
  }

  /* assign grid areas explicitly */
  .settings-grid .sg-time { grid-area: time; }
  .settings-grid .sg-submit { grid-area: submit; }
  .settings-grid .sg-text { grid-area: text; }
  .settings-grid .sg-font { grid-area: font; }
  .settings-grid .sg-color { grid-area: color; }
}
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Settings Panel -->
    <div class="settings-panel" id="settingsPanel" style="display: none;">
      <div class="settings-grid">
        <div class="setting-group sg-time">
          <span class="setting-label">Time:</span>
          <div class="timer-display" id="timerDisplay">60:00</div>
        </div>
        <div class="setting-group sg-submit">
          <button class="submit-btn" id="submitBtn" onclick="submitTest()">SUBMIT TEST</button>
        </div>
        <div class="setting-group sg-text">
          <span class="setting-label">Text:</span>
          <button class="toggle-btn" id="textToggleBtn" onclick="toggleText()">Hide Text</button>
        </div>
        <div class="setting-group sg-font">
          <span class="setting-label">Font Size:</span>
          <div class="font-size-control">
            <input type="range" class="font-slider" id="fontSlider" min="12" max="24" value="14" oninput="changeFontSize(this.value)">
            <span class="font-value" id="fontValue">14px</span>
          </div>
        </div>
        <div class="setting-group sg-color">
          <span class="setting-label">Color:</span>
          <div class="color-scheme-buttons">
            <button class="color-btn active" data-scheme="light" onclick="changeColorScheme('light')">Light</button>
            <button class="color-btn" data-scheme="dark" onclick="changeColorScheme('dark')">Dark</button>
            <button class="color-btn" data-scheme="warm" onclick="changeColorScheme('warm')">Warm</button>
          </div>
        </div>
      </div>
    </div>

    <div class="main-layout">
      <!-- Sidebar Navigation -->
      <aside class="sidebar mobile-hidden" id="sidebar">
        <ul class="part-nav">
          <li class="part-nav-item">
            <button class="part-nav-link" onclick="showPart(1)">Part 1 (Q1-6)</button>
          </li>
          <li class="part-nav-item">
            <button class="part-nav-link" onclick="showPart(2)">Part 2 (Q7-13)</button>
          </li>
          <li class="part-nav-item">
            <button class="part-nav-link" onclick="showPart(3)">Part 3 (Q14-18)</button>
          </li>
          <li class="part-nav-item">
            <button class="part-nav-link" onclick="showPart(4)">Part 4 (Q19-24)</button>
          </li>
          <li class="part-nav-item">
            <button class="part-nav-link" onclick="showPart(5)">Part 5 (Q25-30)</button>
          </li>
          <li class="part-nav-item">
            <button class="part-nav-link" onclick="showPart(6)">Part 6 (Q31)</button>
          </li>
          <li class="part-nav-item">
            <button class="part-nav-link" onclick="showPart(7)">Part 7 (Q32)</button>
          </li>
        </ul>
      </aside>

      <!-- Mobile Menu Button -->
      <button class="mobile-menu-btn" id="mobileMenuBtn" onclick="toggleMobileMenu()">☰</button>

      <!-- Content Area -->
      <main class="content-area" id="contentArea">
        <!-- Landing Screen -->
        <div id="landingScreen" class="landing-screen">
          <h1>Cambridge English A2 KET Mock Test 1</h1>
          <p>Duration: 60 minutes</p>
          
          <div class="image-upload-section">
            <h2>Part 7 Setup</h2>
            <p class="upload-instruction">Please upload 3 images for Part 7 (Story Writing)</p>
            <input type="file" class="image-upload-input" id="imageUpload" accept="image/*" multiple onchange="handleImageUpload(event)">
            <p style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-top: var(--space-8);">After uploading, use the arrows to reorder images if needed</p>
            <div class="uploaded-images" id="uploadedImages"></div>
          </div>
          
          <button class="start-test-btn" id="startTestBtn" onclick="startTest()" disabled>Start Test</button>
        </div>

        <!-- Test Parts (Hidden Initially) -->
        <div id="testContent" style="display: none;"></div>
      </main>
    </div>
  </div>

  <script>
    // Application State
    const state = {
      currentPart: 1,
      textVisible: true,
      fontSize: 14,
      colorScheme: 'light',
      uploadedImages: [],
      testTimer: 3600, // 60 minutes in seconds
      timerInterval: null,
      testStarted: false,
      answers: {
        part1: {},
        part2: {},
        part3: {},
        part4: {},
        part5: {},
        part6: '',
        part7: ''
      }
    };

    // Test Data
    const testData = {
      part1: {
        title: 'Part 1 - Questions 1-6',
        questions: {
          1: {
            text: 'Hi Dave, I hope you can still play football today. The time of the game has changed to 5.00 p.m. See you there. Mike',
            options: {
              A: 'Dave and Mike will go to the game together.',
              B: 'Mike thinks Dave wants to change the time of the game.',
              C: 'Mike wants Dave to know the time of the game.'
            }
          },
          2: {
            text: 'WANTED: Cleaner\nNo experience needed\nMust be hard worker\nPhone: 07654321111',
            options: {
              A: 'Somebody wants a cleaner with no experience.',
              B: 'Somebody wants a cleaner and experience is not important.',
              C: 'Somebody wants a hard-working cleaner with no experience.'
            }
          },
          3: {
            text: 'To: Diana\nFrom: Ruth\n\nDiana,\n\nSorry, I will be late for our meeting today. Please start the meeting without me and I will join you when I can.\n\nRuth',
            options: {
              A: 'Ruth will come to the meeting after it starts.',
              B: 'Ruth wants Diana to wait for her before the meeting.',
              C: 'Ruth will start the meeting later than she planned to start it.'
            }
          },
          4: {
            text: 'Special Supermarket Offer!\nToday only!\n5 bananas for £2\nOffer ends at 5 p.m.',
            options: {
              A: 'After 5 p.m. bananas will be more expensive.',
              B: 'You can only buy bananas today.',
              C: 'Before 5 p.m. there is no special offer.'
            }
          },
          5: {
            text: 'Henry, I forgot eggs. We don\'t need many, but I want you to bake a cake. Can you get some on your way home? Monika',
            options: {
              A: 'Monika wants to bake a cake.',
              B: 'Monika wants Henry to buy eggs.',
              C: 'Monika doesn\'t need eggs.'
            }
          },
          6: {
            text: 'LATE NIGHT SHOPPING!\nUntil 8 p.m. in the week and until 10 p.m. at the weekend',
            options: {
              A: 'On Mondays you can shop at 9 p.m.',
              B: 'On Fridays you can only shop after 8 p.m.',
              C: 'On Saturdays and Sundays you can shop at 9 p.m.'
            }
          }
        }
      },
      part2: {
        title: 'Part 2 - Questions 7-13',
        passageTitle: 'Talking about Sport',
        passages: {
          Alan: 'I started playing tennis when I was five years old, but I was never very good at it. My parents really wanted me to do well and paid for me to have lessons outside school, but I always preferred football. I\'m good enough to be in a top local team. With tennis, I could never hit the ball where I wanted it to go - it was always too high or too far. Finally, my parents let me stop going to tennis lessons and I\'ve spent my time playing football since then.',
          Rod: 'My favourite sport has always been rugby. I\'ve tried other sports and I was good at tennis. I won a tennis competition at school and my sports teacher told me that I was an excellent tennis player. But I didn\'t enjoy it as much as rugby because I like being part of a team. So I stopped playing tennis when I was about thirteen. My teacher and parents thought I should continue with it, but I preferred rugby.',
          Ben: 'I\'ve always played a lot of sport. It\'s an important part of my life, and since I left school I do a wide variety of different types of sports golf, rugby, tennis and football. I\'m quite good at all of them, but I can\'t really say that I enjoy one of them more than the others. I\'m probably best at rugby because I\'m a big person, and it is hard to stop me when I\'m running fast.'
        },
        questions: {
          7: { question: 'Who doesn\'t have a favourite sport?', options: { A: 'Alan', B: 'Rod', C: 'Ben' } },
          8: { question: 'Who was very good at a sport that was not their favourite?', options: { A: 'Alan', B: 'Rod', C: 'Ben' } },
          9: { question: 'Who had extra lessons in a sport?', options: { A: 'Alan', B: 'Rod', C: 'Ben' } },
          10: { question: 'Who says their body size helps them do a sport?', options: { A: 'Alan', B: 'Rod', C: 'Ben' } },
          11: { question: 'Who has enjoyed football all their life?', options: { A: 'Alan', B: 'Rod', C: 'Ben' } },
          12: { question: 'Who likes to play with a group of other people?', options: { A: 'Alan', B: 'Rod', C: 'Ben' } },
          13: { question: 'Who says they are good at only one sport?', options: { A: 'Alan', B: 'Rod', C: 'Ben' } }
        }
      },
      part3: {
        title: 'Part 3 - Questions 14-18',
        passageTitle: 'A very clever family',
        passage: 'The Smiths are possibly the cleverest family in the country, and now the youngest member, ten-year-old Charlotte, has won a national spelling competition to add to the family\'s successes. Charlotte is the youngest ever winner of the National Young Spelling Bee Competition - the youngest winner before her was her older sister, Helen, who won it when she was eleven.\n\nCharlotte and Helen\'s older brother, Mark, is also very clever. He finished school early and went to university at the age of fifteen, three years before most young people start their university studies. The children\'s parents, Charles and Vivien, are both teachers and say their children\'s success comes from working hard, playing hard and following strict rules about homework and bedtimes.\n\n\'Other people think that Charles and I don\'t let the children have any time to relax and play, and that we\'re always making them do their homework. But it\'s not true!\' says Vivien. \'We have lots of fun time in the family. But there\'s a time for fun and there\'s a time for work, and we make sure the children understand that work comes before play.\n\nWhen Charlotte took part in the spelling competition the whole family, including her grandparents, went to watch her. Helen took off a day from school - the first day in her life that she missed going to school. \'I felt bad about missing school, Helen said, \'but I think it was important to Charlotte that I was there.\'',
        questions: {
          14: { question: 'Charlotte won the spelling competition', options: { A: 'after her sister.', B: 'when she was eleven.', C: 'when she was older than Helen.' } },
          15: { question: 'Most people', options: { A: 'go to university early.', B: 'are like Mark when they go to university.', C: 'start university at the age of eighteen.' } },
          16: { question: 'Charles and Vivien help their children by', options: { A: 'letting them relax and play any time they want.', B: 'making them do their homework before they relax.', C: 'not letting them have any time to relax and play.' } },
          17: { question: 'When Charlotte won the competition,', options: { A: 'Helen missed it because she was at school.', B: 'all the family were there, but not her grandparents.', C: 'her brother, sister, parents and grandparents were watching.' } },
          18: { question: 'Helen said that', options: { A: 'Charlotte wanted her to be at the competition.', B: 'Charlotte missed school for the competition.', C: 'Charlotte thought competitions were more important than school.' } }
        }
      },
      part4: {
        title: 'Part 4 - Questions 19-24',
        passageTitle: 'The History of Cars',
        passage: 'Cars have a long and interesting history. It is difficult to (19) .................... when the first car was made. Most people (20) .................... that it was made by Karl Benz in 1885. Then in the early twentieth century, cars (21) .................... widely available.\n\nOne of the first cars that it was (22) .................... for ordinary working people to buy was the Model T Ford, made by Henry Ford in the USA. Henry Ford found a way of making a large number of cars quickly and cheaply, and this changed the way that people thought about how to manufacture things. By 1927, Ford had (23) .................... 15 million cars.\n\nToday, car-making (24) .................... jobs to millions of workers. But the world is changing, and the future of cars is far from clear.',
        questions: {
          19: { question: 'Blank 19', options: { A: 'say', B: 'talk', C: 'believe' } },
          20: { question: 'Blank 20', options: { A: 'allow', B: 'agree', C: 'arrive' } },
          21: { question: 'Blank 21', options: { A: 'turned', B: 'started', C: 'became' } },
          22: { question: 'Blank 22', options: { A: 'possible', B: 'general', C: 'ready' } },
          23: { question: 'Blank 23', options: { A: 'sold', B: 'spent', C: 'shown' } },
          24: { question: 'Blank 24', options: { A: 'has', B: 'wins', C: 'gives' } }
        }
      },
      part5: {
        title: 'Part 5 - Questions 25-30',
        text: 'Hi Henry,\n\nI hope you\'re well. I\'m having (0) a birthday party next week and I hope (25) .................... can come. It\'s (26) .................... Friday evening from 8.00 p.m. until late. I\'m having it (27) .................... home to keep things simple. I\'m asking everyone (28) .................... bring some food to share. Can you bring something too?\n\nIf so, (29) .................... me know what you will bring. Then I can tell the others to bring (30) .................... different.\n\nSee you soon,\nHelen'
      },
      part6: {
        title: 'Part 6 - Question 31',
        prompt: 'You want to meet your English friend, Jane, for lunch this weekend.\n\nWrite an email to Jane.\n\nIn your email:\n• suggest meeting for lunch this weekend\n• say when you would like to have lunch\n• say where you would like to have lunch\n\nWrite 25 words or more.\nWrite the email on your answer sheet.',
        minWords: 25
      },
      part7: {
        title: 'Part 7 - Question 32',
        prompt: 'Look at the three pictures.\n\nWrite the story shown in the pictures.\n\nWrite 35 words or more.\nWrite the story on your answer sheet.',
        minWords: 35
      }
    };

    // Image Upload Handler
    function handleImageUpload(event) {
      const files = event.target.files;
      if (files.length !== 3) {
        alert('Please select exactly 3 images.');
        event.target.value = '';
        return;
      }

      state.uploadedImages = [];
      const uploadedImagesDiv = document.getElementById('uploadedImages');
      uploadedImagesDiv.innerHTML = '';

      let loadedCount = 0;
      Array.from(files).forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          state.uploadedImages.push({id: index, dataUrl: e.target.result, order: index});
          loadedCount++;
          
          if (loadedCount === 3) {
            renderImagePreviews();
            document.getElementById('startTestBtn').disabled = false;
          }
        };
        reader.readAsDataURL(file);
      });
    }

    // Render Image Previews with Reorder Controls
    function renderImagePreviews() {
      const container = document.getElementById('uploadedImages');
      container.innerHTML = '';
      
      // Sort images by order
      const sortedImages = [...state.uploadedImages].sort((a, b) => a.order - b.order);
      
      sortedImages.forEach((img, index) => {
        const box = document.createElement('div');
        box.className = 'image-preview-box';
        
        const imgElement = document.createElement('img');
        imgElement.src = img.dataUrl;
        imgElement.alt = `Image ${index + 1}`;
        
        const controls = document.createElement('div');
        controls.className = 'reorder-buttons';
        
        const upBtn = document.createElement('button');
        upBtn.className = 'reorder-btn';
        upBtn.textContent = '↑ Up';
        upBtn.disabled = index === 0;
        upBtn.onclick = () => moveImage(index, -1);
        
        const downBtn = document.createElement('button');
        downBtn.className = 'reorder-btn';
        downBtn.textContent = '↓ Down';
        downBtn.disabled = index === sortedImages.length - 1;
        downBtn.onclick = () => moveImage(index, 1);
        
        controls.appendChild(upBtn);
        controls.appendChild(downBtn);
        
        box.appendChild(imgElement);
        box.appendChild(controls);
        container.appendChild(box);
      });
    }

    // Move Image Up or Down
    function moveImage(currentIndex, direction) {
      const sortedImages = [...state.uploadedImages].sort((a, b) => a.order - b.order);
      const newIndex = currentIndex + direction;
      
      if (newIndex < 0 || newIndex >= sortedImages.length) return;
      
      // Swap orders
      const tempOrder = sortedImages[currentIndex].order;
      sortedImages[currentIndex].order = sortedImages[newIndex].order;
      sortedImages[newIndex].order = tempOrder;
      
      renderImagePreviews();
    }

    // Start Test
    function startTest() {
      document.getElementById('landingScreen').style.display = 'none';
      document.getElementById('testContent').style.display = 'block';
      document.getElementById('settingsPanel').style.display = 'block';
      state.testStarted = true;
      startTimer();
      showPart(1);
      // settings panel visible now — update sticky offsets
      updatePart4Sticky();
    }

    // Timer Functions
    function startTimer() {
      state.timerInterval = setInterval(() => {
        state.testTimer--;
        updateTimerDisplay();
        
        if (state.testTimer <= 0) {
          clearInterval(state.timerInterval);
          handleTimeExpired();
        }
      }, 1000);
    }

    function updateTimerDisplay() {
      const minutes = Math.floor(state.testTimer / 60);
      const seconds = state.testTimer % 60;
      const display = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      
      const timerElement = document.getElementById('timerDisplay');
      timerElement.textContent = display;
      
      // Warning color at 5 minutes or less
      if (state.testTimer <= 300) {
        timerElement.classList.add('warning');
      } else {
        timerElement.classList.remove('warning');
      }
    }

    function handleTimeExpired() {
      alert("Time's Up! The test has ended. Please submit your answers.");
      
      // Disable all inputs
      document.querySelectorAll('input, textarea').forEach(el => {
        el.disabled = true;
      });
      
      // Highlight submit button
      document.getElementById('submitBtn').classList.add('highlight');
    }

    // Show Part
    function showPart(partNumber) {
      state.currentPart = partNumber;
      const contentArea = document.getElementById('testContent');

      // Ensure sidebar sits below the settings panel on mobile
      const settingsPanel = document.getElementById('settingsPanel');
      const sidebar = document.getElementById('sidebar');
      if (sidebar && settingsPanel) {
        sidebar.style.top = settingsPanel.offsetHeight + 'px';
      }

      // When viewing Part 4, always show the text area side-by-side
      if (partNumber === 4) {
        state.textVisible = true;
        const btn = document.getElementById('textToggleBtn');
        if (btn) {
          btn.textContent = 'Hide Text';
          btn.classList.remove('inactive');
        }
      }
      
      // Update navigation active state
      document.querySelectorAll('.part-nav-link').forEach((link, index) => {
        link.classList.toggle('active', index + 1 === partNumber);
      });

      // Hide mobile menu after selection
      if (window.innerWidth <= 768) {
        document.getElementById('sidebar').classList.remove('mobile-visible');
        document.getElementById('sidebar').classList.add('mobile-hidden');
      }

      // Render appropriate part
      switch(partNumber) {
        case 1:
          contentArea.innerHTML = renderPart1();
          break;
        case 2:
          contentArea.innerHTML = renderPart2();
          break;
        case 3:
          contentArea.innerHTML = renderPart3();
          break;
        case 4:
          contentArea.innerHTML = renderPart4();
          // Ensure Part 4 passage stays sticky and sized correctly
          updatePart4Sticky();
          break;
        case 5:
          contentArea.innerHTML = renderPart5();
          break;
        case 6:
          contentArea.innerHTML = renderPart6();
          break;
        case 7:
          contentArea.innerHTML = renderPart7();
          break;
      }
    }

    // Render Part 1
    function renderPart1() {
      const data = testData.part1;
      let html = `<div class="part-content"><h2 class="part-title">${data.title}</h2>`;
      
      for (let qNum in data.questions) {
          const q = data.questions[qNum];
          const hideClass = !state.textVisible ? 'hidden' : '';

          html += `
            <div class="part-content-wrapper ${!state.textVisible ? 'text-hidden' : ''}">
              <div class="text-area ${hideClass}">
              <div class="passage">
                <p>${q.text.replace(/\n/g, '<br>')}</p>
              </div>
            </div>
            <div class="questions-area">
              <div class="question-block">
                <div class="question-text">Question ${qNum}</div>
            <div class="options">
              <label class="option-label ${state.answers.part1[qNum] === 'A' ? 'selected' : ''}">
                <input type="radio" name="q${qNum}" value="A" class="option-radio" onchange="saveAnswer(1, ${qNum}, 'A')" ${state.answers.part1[qNum] === 'A' ? 'checked' : ''}>
                <span class="option-text"><strong>A</strong> ${q.options.A}</span>
              </label>
              <label class="option-label ${state.answers.part1[qNum] === 'B' ? 'selected' : ''}">
                <input type="radio" name="q${qNum}" value="B" class="option-radio" onchange="saveAnswer(1, ${qNum}, 'B')" ${state.answers.part1[qNum] === 'B' ? 'checked' : ''}>
                <span class="option-text"><strong>B</strong> ${q.options.B}</span>
              </label>
              <label class="option-label ${state.answers.part1[qNum] === 'C' ? 'selected' : ''}">
                <input type="radio" name="q${qNum}" value="C" class="option-radio" onchange="saveAnswer(1, ${qNum}, 'C')" ${state.answers.part1[qNum] === 'C' ? 'checked' : ''}>
                <span class="option-text"><strong>C</strong> ${q.options.C}</span>
              </label>
            </div>
              </div>
            </div>
          </div>
        `;
      }
      
      html += '</div></div></div>';
      return html;
    }

    // Render Part 2
    function renderPart2() {
      const data = testData.part2;
      const hideClass = !state.textVisible ? 'hidden' : '';
      
      let html = `<div class="part-content"><h2 class="part-title">${data.title}</h2>`;
      
      html += `<div class="part-content-wrapper">`;
      html += `<div class="part-content-wrapper ${!state.textVisible ? 'text-hidden' : ''}">`;
      html += `<div class="text-area ${hideClass}"><div class="passage"><h3 class="passage-title">${data.passageTitle}</h3>`;
      html += `<p><strong>Alan:</strong> ${data.passages.Alan}</p>`;
      html += `<p><strong>Rod:</strong> ${data.passages.Rod}</p>`;
      html += `<p><strong>Ben:</strong> ${data.passages.Ben}</p>`;
      html += `</div></div>`;
      
      html += `<div class="questions-area">`;
      
      for (let qNum in data.questions) {
        const q = data.questions[qNum];
        html += `
          <div class="question-block">
            <div class="question-text">Question ${qNum}: ${q.question}</div>
            <div class="options">
              <label class="option-label ${state.answers.part2[qNum] === 'A' ? 'selected' : ''}">
                <input type="radio" name="q${qNum}" value="A" class="option-radio" onchange="saveAnswer(2, ${qNum}, 'A')" ${state.answers.part2[qNum] === 'A' ? 'checked' : ''}>
                <span class="option-text"><strong>A</strong> ${q.options.A}</span>
              </label>
              <label class="option-label ${state.answers.part2[qNum] === 'B' ? 'selected' : ''}">
                <input type="radio" name="q${qNum}" value="B" class="option-radio" onchange="saveAnswer(2, ${qNum}, 'B')" ${state.answers.part2[qNum] === 'B' ? 'checked' : ''}>
                <span class="option-text"><strong>B</strong> ${q.options.B}</span>
              </label>
              <label class="option-label ${state.answers.part2[qNum] === 'C' ? 'selected' : ''}">
                <input type="radio" name="q${qNum}" value="C" class="option-radio" onchange="saveAnswer(2, ${qNum}, 'C')" ${state.answers.part2[qNum] === 'C' ? 'checked' : ''}>
                <span class="option-text"><strong>C</strong> ${q.options.C}</span>
              </label>
            </div>
          </div>
        `;
      }
      
      html += '</div></div></div>';
      return html;
    }

    // Render Part 3
    function renderPart3() {
      const data = testData.part3;
      const hideClass = !state.textVisible ? 'hidden' : '';
      
      let html = `<div class="part-content"><h2 class="part-title">${data.title}</h2>`;
      
      html += `<div class="part-content-wrapper ${!state.textVisible ? 'text-hidden' : ''}">`;
      html += `<div class="text-area ${hideClass}"><div class="passage"><h3 class="passage-title">${data.passageTitle}</h3>`;
      const paragraphs = data.passage.split('\n\n');
      paragraphs.forEach(p => {
        html += `<p>${p.replace(/\n/g, ' ')}</p>`;
      });
      html += `</div></div>`;
      
      html += `<div class="questions-area">`;
      
      for (let qNum in data.questions) {
        const q = data.questions[qNum];
        html += `
          <div class="question-block">
            <div class="question-text">Question ${qNum}: ${q.question}</div>
            <div class="options">
              <label class="option-label ${state.answers.part3[qNum] === 'A' ? 'selected' : ''}">
                <input type="radio" name="q${qNum}" value="A" class="option-radio" onchange="saveAnswer(3, ${qNum}, 'A')" ${state.answers.part3[qNum] === 'A' ? 'checked' : ''}>
                <span class="option-text"><strong>A</strong> ${q.options.A}</span>
              </label>
              <label class="option-label ${state.answers.part3[qNum] === 'B' ? 'selected' : ''}">
                <input type="radio" name="q${qNum}" value="B" class="option-radio" onchange="saveAnswer(3, ${qNum}, 'B')" ${state.answers.part3[qNum] === 'B' ? 'checked' : ''}>
                <span class="option-text"><strong>B</strong> ${q.options.B}</span>
              </label>
              <label class="option-label ${state.answers.part3[qNum] === 'C' ? 'selected' : ''}">
                <input type="radio" name="q${qNum}" value="C" class="option-radio" onchange="saveAnswer(3, ${qNum}, 'C')" ${state.answers.part3[qNum] === 'C' ? 'checked' : ''}>
                <span class="option-text"><strong>C</strong> ${q.options.C}</span>
              </label>
            </div>
          </div>
        `;
      }
      
      html += '</div>';
      return html;
    }

    // Render Part 4
    function renderPart4() {
      const data = testData.part4;
      
      // For Part 4 we want a persistent side-by-side view: passage (left) + questions (right)
      // Ensure the passage is never hidden by the Hide Text toggle by marking it with `part4-text`.
      let html = `<div class="part-content"><h2 class="part-title">${data.title}</h2>`;

      html += `<div class="part-content-wrapper part4-wrapper">`;
      html += `<div class="text-area part4-text"><div class="passage"><h3 class="passage-title">${data.passageTitle}</h3>`;
      html += `<p>${data.passage.replace(/\n/g, '<br><br>')}</p>`;
      html += `</div></div>`;

      html += `<div class="questions-area">`;

      for (let qNum in data.questions) {
        const q = data.questions[qNum];
        html += `
          <div class="question-block">
            <div class="question-text">Question ${qNum}: ${q.question}</div>
            <div class="options">
              <label class="option-label ${state.answers.part4[qNum] === 'A' ? 'selected' : ''}">
                <input type="radio" name="q${qNum}" value="A" class="option-radio" onchange="saveAnswer(4, ${qNum}, 'A')" ${state.answers.part4[qNum] === 'A' ? 'checked' : ''}>
                <span class="option-text"><strong>A</strong> ${q.options.A}</span>
              </label>
              <label class="option-label ${state.answers.part4[qNum] === 'B' ? 'selected' : ''}">
                <input type="radio" name="q${qNum}" value="B" class="option-radio" onchange="saveAnswer(4, ${qNum}, 'B')" ${state.answers.part4[qNum] === 'B' ? 'checked' : ''}>
                <span class="option-text"><strong>B</strong> ${q.options.B}</span>
              </label>
              <label class="option-label ${state.answers.part4[qNum] === 'C' ? 'selected' : ''}">
                <input type="radio" name="q${qNum}" value="C" class="option-radio" onchange="saveAnswer(4, ${qNum}, 'C')" ${state.answers.part4[qNum] === 'C' ? 'checked' : ''}>
                <span class="option-text"><strong>C</strong> ${q.options.C}</span>
              </label>
            </div>
          </div>
        `;
      }

      html += `</div></div>`;
      return html;
    }

    // Render Part 5
    function renderPart5() {
      const data = testData.part5;
      let text = data.text;
      
      // Replace gaps with interactive elements
      for (let i = 25; i <= 30; i++) {
        const savedAnswer = state.answers.part5[i] || '';
        const displayText = savedAnswer || `(${i})`;
        text = text.replace(
          `(${i}) ....................`,
          `<span class="gap-input-wrapper"><span class="gap-number" onclick="focusGap(${i})" id="gap-${i}-display">${displayText}</span></span>`
        );
      }
      
      let html = `
        <div class="part-content">
          <h2 class="part-title">${data.title}</h2>
          <div class="gap-text">${text.replace(/\n/g, '<br>')}</div>
        </div>
      `;
      
      return html;
    }

    // Focus Gap
    function focusGap(gapNumber) {
      const displaySpan = document.getElementById(`gap-${gapNumber}-display`);
      const currentValue = state.answers.part5[gapNumber] || '';
      
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'gap-input';
      input.value = currentValue;
      input.id = `gap-${gapNumber}-input`;
      
      displaySpan.replaceWith(input);
      input.focus();
      
      input.addEventListener('blur', function() {
        saveGapAnswer(gapNumber, input.value);
      });
      
      input.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          saveGapAnswer(gapNumber, input.value);
        }
      });
    }

    // Save Gap Answer
    function saveGapAnswer(gapNumber, value) {
      const input = document.getElementById(`gap-${gapNumber}-input`);
      
      // Check for multiple words
      if (value.trim().includes(' ')) {
        input.classList.add('error');
        alert('Please enter only one word (no spaces allowed).');
        return;
      }
      
      state.answers.part5[gapNumber] = value.trim();
      
      // Replace input with display
      const displayText = value.trim() || `(${gapNumber})`;
      const displaySpan = document.createElement('span');
      displaySpan.className = 'gap-number';
      displaySpan.id = `gap-${gapNumber}-display`;
      displaySpan.textContent = displayText;
      displaySpan.onclick = function() { focusGap(gapNumber); };
      
      input.replaceWith(displaySpan);
    }

    // Render Part 6
    function renderPart6() {
      const data = testData.part6;
      const savedText = state.answers.part6 || '';
      const wordCount = countWords(savedText);
      
      let html = `
        <div class="part-content">
          <h2 class="part-title">${data.title}</h2>
          <div class="writing-section">
            <div class="writing-prompt">${data.prompt.replace(/\n/g, '<br>')}</div>
            <textarea class="writing-textarea" id="part6-textarea" oninput="updateWordCount(6)" placeholder="Write your email here...">${savedText}</textarea>
            <div class="word-count" id="part6-wordcount">Word count: ${wordCount}/${data.minWords} minimum</div>
          </div>
        </div>
      `;
      
      return html;
    }

    // Render Part 7
    function renderPart7() {
      const data = testData.part7;
      const savedText = state.answers.part7 || '';
      const wordCount = countWords(savedText);
      
      let html = `
        <div class="part-content">
          <h2 class="part-title">${data.title}</h2>
          <div class="writing-section">
            <div class="writing-prompt">${data.prompt.replace(/\n/g, '<br>')}</div>
            <div class="image-carousel">
      `;
      
      // Sort images by order before displaying
      const sortedImages = [...state.uploadedImages].sort((a, b) => a.order - b.order);
      sortedImages.forEach((img, index) => {
        html += `<img src="${img.dataUrl}" alt="Story Image ${index + 1}" class="story-image">`;
      });
      
      html += `
            </div>
            <textarea class="writing-textarea" id="part7-textarea" oninput="updateWordCount(7)" placeholder="Write your story here...">${savedText}</textarea>
            <div class="word-count" id="part7-wordcount">Word count: ${wordCount}/${data.minWords} minimum</div>
          </div>
        </div>
      `;
      
      return html;
    }

    // Save Answer
    function saveAnswer(part, question, answer) {
      state.answers[`part${part}`][question] = answer;
      
      // Update UI to show selection
      const labels = document.querySelectorAll(`input[name="q${question}"]`).forEach(radio => {
        const label = radio.closest('.option-label');
        if (radio.checked) {
          label.classList.add('selected');
        } else {
          label.classList.remove('selected');
        }
      });
    }

    // Update Word Count
    function updateWordCount(part) {
      const textarea = document.getElementById(`part${part}-textarea`);
      const text = textarea.value;
      const wordCount = countWords(text);
      const minWords = part === 6 ? testData.part6.minWords : testData.part7.minWords;
      
      document.getElementById(`part${part}-wordcount`).textContent = `Word count: ${wordCount}/${minWords} minimum`;
      
      // Save answer
      state.answers[`part${part}`] = text;
    }

    // Count Words
    function countWords(text) {
      return text.trim().split(/\s+/).filter(word => word.length > 0).length;
    }

    // Toggle Text Visibility
    function toggleText() {
      state.textVisible = !state.textVisible;
      const btn = document.getElementById('textToggleBtn');
      btn.textContent = state.textVisible ? 'Hide Text' : 'Show Text';
      btn.classList.toggle('inactive', !state.textVisible);
      
      // Update visibility of text areas in current view
      const textAreas = document.querySelectorAll('.text-area');
      textAreas.forEach(area => {
        // Never hide Part 4 passage
        if (area.classList.contains('part4-text')) {
          area.classList.remove('hidden');
        } else {
          area.classList.toggle('hidden', !state.textVisible);
        }
      });

      // Toggle wrapper layout so questions expand to full width when text is hidden
      document.querySelectorAll('.part-content-wrapper').forEach(wrapper => {
        if (wrapper.classList.contains('part4-wrapper')) {
          wrapper.classList.remove('text-hidden');
        } else {
          wrapper.classList.toggle('text-hidden', !state.textVisible);
        }
      });
    }

    // Submit Test
    function submitTest() {
      if (!confirm('Are you sure you want to submit your test?')) {
        return;
      }
      
      // Stop timer
      if (state.timerInterval) {
        clearInterval(state.timerInterval);
      }
      
      // Format answers
      const timestamp = new Date().toLocaleString();
      let emailBody = `CAMBRIDGE ENGLISH A2 KET - MOCK TEST 1%0D%0ASubmission Time: ${encodeURIComponent(timestamp)}%0D%0A%0D%0A`;
      
      // Parts 1-4
      emailBody += `PART 1-4 (Multiple Choice):%0D%0A`;
      for (let part = 1; part <= 4; part++) {
        const partAnswers = state.answers[`part${part}`];
        for (let qNum in partAnswers) {
          emailBody += `Q${qNum}: ${partAnswers[qNum]}%0D%0A`;
        }
      }
      
      // Part 5
      emailBody += `%0D%0APART 5 (Gapped Text):%0D%0A`;
      const part5Answers = state.answers.part5;
      for (let gap = 25; gap <= 30; gap++) {
        emailBody += `Gap ${gap}: ${part5Answers[gap] || '(not answered)'}%0D%0A`;
      }
      
      // Part 6
      emailBody += `%0D%0APART 6 (Email Writing):%0D%0A`;
      const part6Text = state.answers.part6 || '(not answered)';
      emailBody += encodeURIComponent(part6Text);
      emailBody += `%0D%0AWord Count: ${countWords(part6Text)}%0D%0A`;
      
      // Part 7
      emailBody += `%0D%0APART 7 (Story Writing):%0D%0A`;
      const part7Text = state.answers.part7 || '(not answered)';
      emailBody += encodeURIComponent(part7Text);
      emailBody += `%0D%0AWord Count: ${countWords(part7Text)}%0D%0A`;
      
      // Create mailto link
      const mailtoLink = `mailto:?subject=Cambridge%20A2%20KET%20Mock%20Test%201%20-%20Submission%20${encodeURIComponent(timestamp)}&body=${emailBody}`;
      
      // Try to open email client
      window.location.href = mailtoLink;
      
      // Also show a copy option
      setTimeout(() => {
        if (confirm('Email client opened. Would you like to copy your answers to clipboard as backup?')) {
          copyAnswersToClipboard(timestamp);
        }
      }, 1000);
    }

    // Copy Answers to Clipboard
    function copyAnswersToClipboard(timestamp) {
      let text = `CAMBRIDGE ENGLISH A2 KET - MOCK TEST 1\nSubmission Time: ${timestamp}\n\n`;
      
      text += `PART 1-4 (Multiple Choice):\n`;
      for (let part = 1; part <= 4; part++) {
        const partAnswers = state.answers[`part${part}`];
        for (let qNum in partAnswers) {
          text += `Q${qNum}: ${partAnswers[qNum]}\n`;
        }
      }
      
      text += `\nPART 5 (Gapped Text):\n`;
      const part5Answers = state.answers.part5;
      for (let gap = 25; gap <= 30; gap++) {
        text += `Gap ${gap}: ${part5Answers[gap] || '(not answered)'}\n`;
      }
      
      text += `\nPART 6 (Email Writing):\n${state.answers.part6 || '(not answered)'}\n`;
      text += `Word Count: ${countWords(state.answers.part6)}\n`;
      
      text += `\nPART 7 (Story Writing):\n${state.answers.part7 || '(not answered)'}\n`;
      text += `Word Count: ${countWords(state.answers.part7)}\n`;
      
      // Copy to clipboard
      navigator.clipboard.writeText(text).then(() => {
        alert('Answers copied to clipboard!');
      }).catch(() => {
        alert('Could not copy to clipboard. Please copy the answers manually from the email.');
      });
    }

    // Change Font Size
    function changeFontSize(size) {
      state.fontSize = size;
      document.body.style.fontSize = `${size}px`;
      document.getElementById('fontValue').textContent = `${size}px`;
      // Update sticky offsets in case settings panel height changed
      updatePart4Sticky();
    }

    // Change Color Scheme
    function changeColorScheme(scheme) {
      state.colorScheme = scheme;
      
      // Remove all color classes
      document.body.classList.remove('dark-mode', 'warm-mode');
      
      // Add appropriate class
      if (scheme === 'dark') {
        document.body.classList.add('dark-mode');
      } else if (scheme === 'warm') {
        document.body.classList.add('warm-mode');
      }
      
      // Update button states
      document.querySelectorAll('.color-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.scheme === scheme);
      });
      // color change might affect layout/height — ensure sticky adjusts
      updatePart4Sticky();
    }

    // Toggle Mobile Menu
    function toggleMobileMenu() {
      const sidebar = document.getElementById('sidebar');
      const settingsPanel = document.getElementById('settingsPanel');
      if (sidebar && settingsPanel) {
        sidebar.style.top = settingsPanel.offsetHeight + 'px';
      }
      sidebar.classList.toggle('mobile-visible');
      sidebar.classList.toggle('mobile-hidden');
    }

    // Update Part 4 sticky top/height to account for the settings panel and viewport
    function updatePart4Sticky() {
      const settingsPanel = document.getElementById('settingsPanel');
      const contentArea = document.getElementById('contentArea');
      const part4Areas = document.querySelectorAll('.part4-text');
      const settingsRect = settingsPanel ? settingsPanel.getBoundingClientRect() : {bottom: 0};
      const contentRect = contentArea ? contentArea.getBoundingClientRect() : {top: 0};
      // offset relative to the content area's top (sticky is relative to its scroll container)
      const offset = Math.max(0, settingsRect.bottom - contentRect.top);
      const extraSpacing = 6; // small gap below the settings panel

      part4Areas.forEach(el => {
        // Always use sticky positioning but compute top from the content area so it doesn't overlap questions
        el.style.position = 'sticky';
        el.style.top = (offset + extraSpacing) + 'px';
        el.style.overflowY = 'auto';
        // keep the passage scrollable but not taller than viewport minus controls
        let max = window.innerHeight - (settingsRect.bottom) - (extraSpacing * 2);
        // On very small screens cap the passage to a fraction of the viewport so questions remain visible
        if (window.innerWidth <= 480) {
          const cap = Math.floor(window.innerHeight * 0.35); // 35% of viewport height
          max = Math.min(max, cap);
        }
        el.style.maxHeight = (max > 120 ? max + 'px' : '120px');
        el.style.zIndex = 2; /* ensure it sits above question background but below settings-panel (z-index 100) */
      });
    }

    // Initialize
    window.addEventListener('load', function() {
      // Set initial font size
      document.body.style.fontSize = `${state.fontSize}px`;
      // Ensure sidebar position accounts for the settings panel height (fixes mobile overlap)
      const sidebar = document.getElementById('sidebar');
      const settingsPanel = document.getElementById('settingsPanel');
      if (sidebar && settingsPanel) {
        sidebar.style.top = settingsPanel.offsetHeight + 'px';
      }

      // Update sidebar top on resize (mobile orientation changes)
      window.addEventListener('resize', () => {
        if (sidebar && settingsPanel) {
          sidebar.style.top = settingsPanel.offsetHeight + 'px';
        }
        // Also update Part 4 sticky sizing on resize
        updatePart4Sticky();
      });
      // Also ensure Part 4 sticky is set on load in case test is already started
      updatePart4Sticky();
      // Recompute sticky offsets when orientation changes or when the top bar content may change
      window.addEventListener('orientationchange', updatePart4Sticky);
    });
  </script>
</body>
</html>